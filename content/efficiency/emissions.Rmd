---
title: ""
output: html_document
---

```{r, echo=FALSE, include=FALSE}
# All defaults
## libraries
library(fs)
library(tibble)
library(dplyr)
library(stringr)
library(readxl)
library(lubridate)
library(plotly)
```

```{css, echo=FALSE}

.nav>li>a {
    color: black;
    background-color:#f5f5f5;
    padding: 2px 5px 2px 5px;
    font-size: 14px;
    border-radius: 3px;
}

.nav > li > a:hover, .nav > li > a:focus, .nav > li > a.active {
    color:black;
    background-color:#e0e0e0;
    text-decoration: none;
}

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
base_dir <- ''

co2_data_raw <-  read_xlsx(
  path  = fs::path_abs(
    str_glue("20220614 - STATFOR States Stats With Rte len dist vs 2019.xlsx"),
    start = base_dir),
  sheet = "All Data",
  range = cell_limits(c(1, 1), c(NA, 29))) %>%
  mutate(across(.cols = where(is.instant), ~ as.Date(.x)))%>%
  as_tibble()


co2_data_plot_nw <- co2_data_raw %>%
  # filter(FLIGHT_MONTH =='2022-04-01')%>%
  # filter(STATE_NAME != 'KOSOVO' & STATE_NAME != 'MONACO')%>%
  select(FLIGHT_MONTH, CO2_QTY_TONNES, TF)%>%
  group_by(FLIGHT_MONTH)%>%
  summarise(TTF = sum(TF), TCO2 = sum(CO2_QTY_TONNES))%>%
  mutate(YEAR = as.numeric(format(FLIGHT_MONTH,'%Y')), MONTH = as.numeric(format(FLIGHT_MONTH,'%m')))%>%
  arrange(FLIGHT_MONTH)%>%
  mutate(TTF_IDX=TTF/first(TTF)*100, CO2_IDX=TCO2/first(TCO2)*100)

```


```{r, echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'}
# Network plot option 1

# vertical line function
vline <- function(x = 0, color = "#dcdcdc") {
  list(
    type = "line", 
    y0 = 0, 
    y1 = 1, 
    yref = "paper",
    x0 = x, 
    x1 = x, 
    line = list(color = color, width=1)
  )
}

# anotations
a1 <- list(
  x = '2020-02-15',
  y = 1,
  text = paste("2020"),
  xref = "x",
  yref = "paper",
  showarrow = FALSE
)

a2 <- list(
  x = '2019-02-15',
  y = 1,
  text = paste("2019"),
  xref = "x",
  yref = "paper",
  showarrow = FALSE
)

a3 <- list(
  x = '2021-02-15',
  y = 1,
  text = paste("2021"),
  xref = "x",
  yref = "paper",
  showarrow = FALSE
)

a4 <- list(
  x = '2022-02-15',
  y = 1,
  text = paste("2022"),
  xref = "x",
  yref = "paper",
  showarrow = FALSE
)

# build plot nw co2
co2_nw_plot <- co2_data_plot_nw %>%
  plot_ly(
    # width = 500, 
    height = 350,
    x = ~ FLIGHT_MONTH,
    y = ~ TCO2/1000000,
    yaxis = "y1",
    type = 'scatter',
    mode = 'lines',
    line = list(color = '#ffc000', width = 2),
    name = paste0('CO','<sub>2</sub>',' million tonnes'),
    hovertemplate = paste('<b>CO','<sub>2</sub>',' million tonnes</b>: <br>%{y}',
                          "<extra></extra>", # this is to remove the shadow
                          sep = ""),
    showlegend = T
  )%>%
  add_trace(
    y = ~TCO2/TTF, 
    yaxis = "y2",
    name = paste0('CO','<sub>2</sub>',' emissions (tonnes) per departure'),
    mode = 'lines',
    hovertemplate = paste('<b>CO','<sub>2</sub>',' tonnes/departure</b>: <br>%{y}',
                          "<extra></extra>", # this is to remove the shadow
                          sep = ""),
    line = list(color = '#2990ea', width = 1) 
    ) %>%
  layout(
    shapes = list(vline(as.Date('2022-01-01')), vline(as.Date('2021-01-01')),vline(as.Date('2020-01-01'))),
    annotations = list(a1, a2, a3, a4),
     autosize = T,
    font = list(family = "Helvetica"),
    xaxis = list(
      title = "",
      # fixedrange = TRUE,
      tickangle=-40,
      dtick = "M2", tickformat="%b%y",
      # range = c(~min(FLIGHT_DATE),~max(FLIGHT_DATE)),
      fixedrange = TRUE, # disables zoom
      showline = T,
      linecolor = '#dcdcdc',
      showgrid = F
    ),
    yaxis = list(
      title = paste0('CO','<sub>2</sub>',' emissions (million tonnes)'),
      titlefont   = list(size = 12),
      fixedrange = TRUE,
      rangemode='nonnegative', #forces the zeros of the two vertical axis to overlap
      hoverformat = ",.1f",
      # barmode = 'group',
    # range = c(0,ceiling(max(nw_data_plot$ROLL_WK_AVG_DLY)/10000)*10000),
      # tick0 = 1,
      # ticksuffix = "M",
      tickformat=",.#f",
      zeroline = T, showline = F, showgrid = T
    ),
    yaxis2 = list (
      overlaying = "y",
      rangemode='nonnegative',
      side = "right",
      title = paste0('CO','<sub>2</sub>',' emissions (tonnes) per departure'),
      titlefont = list(size = 13),
      barmode = 'group',
      # ticksuffix = "k",
      hoverformat = ",.1f",
      automargin = T,
      range = list(0,35),
      showgrid = F
    ),
    hovermode = "x unified",
    legend = list(orientation = 'h', xanchor = "left", x = 0.0, y=-0.20)
  )%>%
    config(
      responsive = TRUE,
      displaylogo = FALSE,
      modeBarButtons = list(list("toImage"))
      )

```


```{r, echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'}
# Network plot option 2

# build plot nw co2
co2_nw_plot2 <- co2_data_plot_nw %>%
  plot_ly(
    # width = 500, 
    height = 350,
    x = ~ FLIGHT_MONTH,
    y = ~ TCO2/1000000,
    yaxis = "y1",
    type = 'scatter',
    mode = 'lines',
    line = list(color = '#ffc000', width = 2),
    name = paste0('CO','<sub>2</sub>',' million tonnes'),
    hovertemplate = paste('<b>CO','<sub>2</sub>',' million tonnes</b>: <br>%{y}',
                          "<extra></extra>", # this is to remove the shadow
                          sep = ""),
    showlegend = T
  )%>%
  add_trace(
    y = ~TTF/1000, 
    yaxis = "y2",
    name = paste0('Departures'),
    mode = 'lines',
    hovertemplate = paste('Departures (thousands): <br>%{y}',
                          "<extra></extra>", # this is to remove the shadow
                          sep = ""),
    line = list(color = '#2990ea', width = 1) 
    ) %>%
  layout(
    shapes = list(vline(as.Date('2022-01-01')), vline(as.Date('2021-01-01')),vline(as.Date('2020-01-01'))),
    annotations = list(a1, a2, a3, a4),
     autosize = T,
    font = list(family = "Helvetica"),
    xaxis = list(
      title = "",
      # fixedrange = TRUE,
      tickangle=-40,
      dtick = "M2", tickformat="%b%y",
      # range = c(~min(FLIGHT_DATE),~max(FLIGHT_DATE)),
      fixedrange = TRUE, # disables zoom
      showline = T,
      linecolor = '#dcdcdc',
      showgrid = F
    ),
    yaxis = list(
      title = paste0('CO','<sub>2</sub>',' emissions (million tonnes)'),
      titlefont   = list(size = 12),
      fixedrange = TRUE,
      rangemode='nonnegative', #forces the zeros of the two vertical axis to overlap
      hoverformat = ",.1f",
      # barmode = 'group',
    # range = c(0,ceiling(max(nw_data_plot$ROLL_WK_AVG_DLY)/10000)*10000),
      # tick0 = 1,
      # ticksuffix = "M",
      tickformat=",.#f",
      zeroline = T, showline = F, showgrid = T
    ),
    yaxis2 = list (
      overlaying = "y",
      rangemode='nonnegative',
      side = "right",
      title = paste0('Departures (thousands)'),
      titlefont = list(size = 13),
      barmode = 'group',
      # ticksuffix = "k",
      hoverformat = ",.1f",
      automargin = T,
      # range = list(0,35),
      showgrid = F
    ),
    hovermode = "x unified",
    legend = list(orientation = 'h', xanchor = "left", x = 0.0, y=-0.20)
  )%>%
    config(
      responsive = TRUE,
      displaylogo = FALSE,
      modeBarButtons = list(list("toImage"))
      )

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'}
# Network plot option 3

# build plot nw co2
co2_nw_plot3 <- co2_data_plot_nw %>%
  plot_ly(
    # width = 500, 
    height = 350,
    x = ~ FLIGHT_MONTH,
    y = ~ CO2_IDX,
    yaxis = "y1",
    type = 'scatter',
    mode = 'lines',
    line = list(color = '#ffc000', width = 2),
    name = paste0('CO','<sub>2</sub>',' index'),
    hovertemplate = paste('<b>CO','<sub>2</sub>',' index</b>: <br>%{y}',
                          "<extra></extra>", # this is to remove the shadow
                          sep = ""),
    showlegend = T
  )%>%
  add_trace(
    y = ~TTF_IDX, 
    yaxis = "y1",
    name = paste0('Departures index'),
    mode = 'lines',
    hovertemplate = paste('Departures index: <br>%{y}',
                          "<extra></extra>", # this is to remove the shadow
                          sep = ""),
    line = list(color = '#2990ea', width = 1) 
    ) %>%
  layout(
    shapes = list(vline(as.Date('2022-01-01')), vline(as.Date('2021-01-01')),vline(as.Date('2020-01-01'))),
    annotations = list(a1, a2, a3, a4),
     autosize = T,
    font = list(family = "Helvetica"),
    xaxis = list(
      title = "",
      # fixedrange = TRUE,
      tickangle=-40,
      dtick = "M2", tickformat="%b%y",
      # range = c(~min(FLIGHT_DATE),~max(FLIGHT_DATE)),
      fixedrange = TRUE, # disables zoom
      showline = T,
      linecolor = '#dcdcdc',
      showgrid = F
    ),
    yaxis = list(
      title = paste0('Index (100 = Jan 2019)'),
      titlefont   = list(size = 12),
      fixedrange = TRUE,
      rangemode='nonnegative', #forces the zeros of the two vertical axis to overlap
      hoverformat = ",.1f",
      # barmode = 'group',
    # range = c(0,ceiling(max(nw_data_plot$ROLL_WK_AVG_DLY)/10000)*10000),
      # tick0 = 1,
      # ticksuffix = "M",
      tickformat=",.#f",
      zeroline = T, showline = F, showgrid = T
    ),
    # yaxis2 = list (
    #   overlaying = "y",
    #   rangemode='nonnegative',
    #   side = "right",
    #   title = paste0('Departures (thousands)'),
    #   titlefont = list(size = 13),
    #   barmode = 'group',
    #   # ticksuffix = "k",
    #   hoverformat = ",.1f",
    #   automargin = T,
    #   # range = list(0,35),
    #   showgrid = F
    # ),
    hovermode = "x unified",
    legend = list(orientation = 'h', xanchor = "left", x = 0.0, y=-0.20)
  )%>%
    config(
      responsive = TRUE,
      displaylogo = FALSE,
      modeBarButtons = list(list("toImage"))
      )

```


```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
#data plot state
last_date <- max(co2_data_raw$FLIGHT_MONTH, na.rm=TRUE)

co2_data_plot_state <- co2_data_raw %>%
  filter(FLIGHT_MONTH ==last_date)%>%
  # filter(STATE_NAME != 'KOSOVO' & STATE_NAME != 'MONACO')%>%
  select(STATE_NAME, CO2_QTY_TONNES, TF, MOM_GROWTH_CO2, MOM_GROWTH_TF)%>%
  mutate(STATE_NAME = gsub("(?<=\\b)([a-z])", "\\U\\1", tolower(STATE_NAME), perl=TRUE)) %>%
  mutate(STATE_NAME = gsub("Of", "of",STATE_NAME, ignore.case = FALSE))%>%
  mutate(STATE_NAME = gsub("And", "and",STATE_NAME, ignore.case = FALSE))%>%
  mutate(STATE_NAME = gsub("Turkey", "Türkiye",STATE_NAME, ignore.case = FALSE))%>%
  mutate(CO2_DEP = ifelse(TF!=0,CO2_QTY_TONNES/TF,0))%>%
  mutate(CO2_DEP_2019 = ifelse(TF!=0, CO2_QTY_TONNES/TF *(MOM_GROWTH_TF+1)/(MOM_GROWTH_CO2+1), 0))%>%
  mutate(MOM_GROWTH_CO2_DEP = ifelse(CO2_DEP_2019!=0, CO2_DEP/CO2_DEP_2019-1, 0))%>%
  mutate(LOLLI = ifelse(abs(MOM_GROWTH_CO2)>=abs(MOM_GROWTH_CO2_DEP), MOM_GROWTH_CO2, MOM_GROWTH_CO2_DEP))%>%
  mutate(LOLLI2 = ifelse(sign(MOM_GROWTH_CO2)!=sign(MOM_GROWTH_CO2_DEP), ifelse(abs(MOM_GROWTH_CO2)>=abs(MOM_GROWTH_CO2_DEP),MOM_GROWTH_CO2_DEP,MOM_GROWTH_CO2), 0))%>%
  mutate(INDEX = row_number())

  # from https://stackoverflow.com/questions/24956546/capitalizing-letters-r-equivalent-of-excel-proper-function
  

```


```{r, echo=FALSE, message=FALSE, warning=FALSE, out.width='100%'}

# build plot state
co2_state_plot <- co2_data_plot_state %>%
  plot_ly(
    # width = 500, 
    height = 370,
    x = ~ STATE_NAME,
    y = ~ CO2_QTY_TONNES/1000000,
    yaxis = "y1",
    type = "bar",
    marker = list(color = '#ffc000'),
    # offsetgroup = 1,
    name = paste0('CO','<sub>2</sub>',' million tonnes'),
    hovertemplate = paste('<b>CO','<sub>2</sub>',' million tonnes</b>: <br>%{y}',
                          "<extra></extra>", # this is to remove the shadow
                          sep = ""),
    # hoverinfo = "none",
    showlegend = T
  )%>%
  add_trace(
    x = ~ STATE_NAME,
    y = ~ CO2_QTY_TONNES/TF,
    inherit = FALSE,
    yaxis = "y2",
    type = 'scatter',  
    mode = 'markers',
    name = paste0('CO','<sub>2</sub>',' emissions (tonnes) per departure'),
    marker = list(color = '#2990ea', symbol = "diamond"),
    # offsetgroup = 2,
    hovertemplate = paste('<b>CO','<sub>2</sub>',' tonnes/departure</b>: <br>%{y}',
                          "<extra></extra>", # this is to remove the shadow
                          sep = ""),
    showlegend = T
  )%>%
  layout(
    autosize = T,
    font = list(family = "Helvetica"),
    xaxis = list(
      title = "",
      # fixedrange = TRUE,
      # autotick = T,
      tickangle=-40,
      # tickfont = list(size = 1),
      # range = c(~min(FLIGHT_DATE),~max(FLIGHT_DATE)),
      fixedrange = TRUE, # disables zoom
      # type = 'multicategory', 
      showgrid = F
    ),
    yaxis = list(
      title = paste0('CO','<sub>2</sub>',' emissions (million tonnes)'),
      titlefont   = list(size = 12),
      fixedrange = TRUE,
      rangemode='nonnegative', #forces the zeros of the two vertical axis to overlap
      hoverformat = ",.2f",
      barmode = 'group',
    # range = c(0,ceiling(max(nw_data_plot$ROLL_WK_AVG_DLY)/10000)*10000),
      # tick0 = 1,
      ticksuffix = "M",
      tickformat=",.1f",
      zeroline = T, showline = F, showgrid = T
    ),
    yaxis2 = list (
      overlaying = "y",
      rangemode='nonnegative',
      side = "right",
      title = paste0('<br>','CO','<sub>2</sub>',' emissions (tonnes) per departure'),
      # title = "Departures (thousands)",
      titlefont = list(size = 13),
      barmode = 'group',
      # ticksuffix = "k",
      hoverformat = ",.1f",
      automargin = T,
      # range = list(0,~max(ROLL_WK_AVG_DLY_PER_FLT)+1),
      showgrid = F
    ),
    # bargap = 0,
    hovermode = "x unified",
    margin = list(b=0),
    legend = list(orientation = 'h', xanchor = "left", x = 0.0, y = 1.05)
  )%>%
    config(
      responsive = TRUE,
      displaylogo = FALSE,
      modeBarButtons = list(list("toImage"))
      )

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}

line <- list(
  type = "line",
  line = list(color = "#d2d2d2",  width=0.5),
  xref = "x",
  yref = "y",
  layer="below"
)

lines <- list()
for (i in co2_data_plot_state$INDEX) {
  line[["x0"]] <- i-1
  line[["x1"]] <- i-1
  line[["y0"]] <- nth(co2_data_plot_state$LOLLI, i)
  line[["y1"]] <- nth(co2_data_plot_state$LOLLI2, i)
  lines <- c(lines, list(line))
}

# build plot total
co2_lolli_plot <- co2_data_plot_state %>%
  plot_ly(
    # width = 500, 
    height = 320,
    x = ~ STATE_NAME,
    y = ~ MOM_GROWTH_CO2,
    yaxis = "y1",
    type = 'scatter', mode = 'markers',  
    text = ~ paste0(if_else(MOM_GROWTH_CO2>=0,'+','-'),format(round(abs(MOM_GROWTH_CO2)*100,1),nsmall=1),'%'),
    marker = list(color = '#ffc000'),
    name = paste0('CO','<sub>2</sub>',' variation (% vs 2019)'),
    hovertemplate = paste('<b>CO','<sub>2</sub>','</b>: <br>%{text}',
                          "<extra></extra>", # this is to remove the shadow
                          sep = ""),
    # hoverinfo = "none",
    showlegend = T
  )%>%
  # add_trace(
  #   x = ~ STATE_NAME,
  #   y = ~ LOLLI,
  #   inherit = FALSE,
  #   yaxis = "y1",
  #   type = 'bar',  
  #   name = '',
  #   marker = list(color = '#d2d2d2'),
  #   hoverinfo="none",
  #   # offsetgroup = 2,
  #   # hovertemplate = "",
  #   showlegend = F
  # )%>%
  add_trace(
    x = ~ STATE_NAME,
    y = ~ MOM_GROWTH_CO2_DEP,
    inherit = FALSE,
    yaxis = "y1",
    type = 'scatter', mode = 'markers',  
    marker = list(color = '#2990ea'),
    # offsetgroup = 2,
    text = ~ paste0(if_else(MOM_GROWTH_CO2_DEP>=0,'+','-'),format(round(abs(MOM_GROWTH_CO2_DEP)*100,1),nsmall=1),'%'),
    name = paste0('CO','<sub>2</sub>',' per departure variation (% vs 2019)'),
    hovertemplate = paste('<b>CO','<sub>2</sub> per departure','</b>: <br>%{text}',
                          "<extra></extra>", # this is to remove the shadow
                          sep = ""),
    showlegend = T
  )%>%
  # add_trace(
  #   x = ~ STATE_NAME,
  #   y = ~ LOLLI2,
  #   inherit = FALSE,
  #   yaxis = "y1",
  #   type = 'bar',  
  #   name = '',
  #   marker = list(color = '#d2d2d2'),
  #   hoverinfo="none",
  #   # offsetgroup = 2,
  #   # hovertemplate = "",
  #   showlegend = F
  # )%>% 
  layout(
    shapes = lines,
    # bargap = 0.95,
    autosize = T,
    font = list(family = "Helvetica"),
    xaxis = list(
      title = "",
      showticklabels = FALSE,
      # fixedrange = TRUE,
      # autotick = T,
      tickangle=-40,
      # tickfont = list(size = 1),
      # range = c(~min(FLIGHT_DATE),~max(FLIGHT_DATE)),
      fixedrange = TRUE, # disables zoom
      # type = 'multicategory', 
      showgrid = F
    ),
    yaxis = list(
      title = paste0('Variation (%) vs 2019'),
      titlefont   = list(size = 12),
      fixedrange = TRUE,
      # rangemode='nonnegative', #forces the zeros of the two vertical axis to overlap
      # hoverformat = ",.0%",
      barmode = 'group',
    # range = c(0,ceiling(max(nw_data_plot$ROLL_WK_AVG_DLY)/10000)*10000),
      # tick0 = 1,
      ticksuffix = "",
      tickformat=",.0%",
      zeroline = T, showline = F, showgrid = T
    ),
    yaxis2 = list (
      overlaying = "y",
      # rangemode='nonnegative',
      side = "right",
      title = paste0('<br><br>','CO','<sub>2</sub>',' emissions (tonnes) per departure'),
      titlefont = list(size = 13, color='white'),
      ticksuffix = "",
      # hoverformat = "f",
      automargin = T,
      # range = list(0,~max(ROLL_WK_AVG_DLY_PER_FLT)+1),
      showgrid = F
    ),
    # bargap = 0,
    hovermode = "x unified",
    margin = list(t=0, r=50),
    legend = list(orientation = 'h', xanchor = "left", x = 0.0, y = -0.05)
  )%>%
    config(
      responsive = TRUE,
      displaylogo = FALSE,
      # modeBarButtons = list(list("toImage"),
      displayModeBar= FALSE
      )

```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
#Calculate values for scorecards

last_month <- format(last_date,'%B')
last_year <- format(last_date,'%Y')
y2d <- paste0('Year to date: 01 Jan-',format(last_date %m+% months(1) -1,'%d %b'))

#monthly figures
co2_month <- co2_data_plot_nw %>%
  filter(FLIGHT_MONTH==last_date)%>%
  select(TCO2)%>%pull
co2_month_r <- round(co2_month/1000000,1)

co2_month_prev_year<- co2_data_plot_nw %>%
  mutate(PREV_YEAR = lag(TCO2, 12))%>%
  filter(FLIGHT_MONTH==last_date)%>%
  select(PREV_YEAR)%>%pull

dif_co2_month_prev_year <- round((co2_month/co2_month_prev_year-1)*100,0)
dif_co2_month_prev_year <- paste0(if_else(dif_co2_month_prev_year>=0,'+', ''),dif_co2_month_prev_year,'%')

co2_month_2019<- co2_data_plot_nw %>%
  mutate(CO2_2019 = lag(TCO2, (as.numeric(last_year)-2019)*12))%>%
  filter(FLIGHT_MONTH==last_date)%>%
  select(CO2_2019)%>%pull

dif_co2_month_2019 <- round((co2_month/co2_month_2019-1)*100,1)
dif_co2_month_2019 <- paste0(if_else(dif_co2_month_2019>=0,'+', ''),dif_co2_month_2019,'%')

dep_month <- co2_data_plot_nw %>%
  filter(FLIGHT_MONTH==last_date)%>%
  select(TTF)%>%pull
co2_dep_month <- co2_month/dep_month
co2_dep_month_r <- format(round(co2_dep_month,1), nsmall=1)

dep_month_prev_year<- co2_data_plot_nw %>%
  mutate(DEP_PREV_YEAR = lag(TTF, 12))%>%
  filter(FLIGHT_MONTH==last_date)%>%
  select(DEP_PREV_YEAR)%>%pull
co2_dep_month_prev_year <- co2_month_prev_year/dep_month_prev_year

dif_co2_dep_month_prev_year <- round((co2_dep_month/co2_dep_month_prev_year-1)*100,1)
dif_co2_dep_month_prev_year <- paste0(if_else(dif_co2_dep_month_prev_year>=0,'+', ''),format(dif_co2_dep_month_prev_year, nsmall=1),'%')

dep_month_2019<- co2_data_plot_nw %>%
  mutate(DEP_2019 = lag(TTF, (as.numeric(last_year)-2019)*12))%>%
  filter(FLIGHT_MONTH==last_date)%>%
  select(DEP_2019)%>%pull
co2_dep_month_2019 <- co2_month_2019/dep_month_2019

dif_co2_dep_month_2019 <- round((co2_dep_month/co2_dep_month_2019-1)*100,1)
dif_co2_dep_month_2019 <- paste0(if_else(dif_co2_dep_month_2019>=0,'+', ''),format(dif_co2_dep_month_2019, nsmall=1),'%')

#y2d figures

last_month_num <- as.numeric(format(last_date,'%m'))
data_y2d <- co2_data_plot_nw %>%
  filter(MONTH<=last_month_num)%>%
  group_by(YEAR)%>%
  summarise(TTF_Y2D = sum(TTF), TCO2_Y2D = sum(TCO2))

co2_y2d <- data_y2d%>%
  filter(YEAR==last_year)%>%
  select(TCO2_Y2D)%>% pull

dep_y2d <- data_y2d%>%
  filter(YEAR==last_year)%>%
  select(TTF_Y2D)%>%pull
    
co2_y2d_r <- round(co2_y2d/1000000,1)

co2_y2d_prev_year <- data_y2d%>%
  filter(YEAR==as.numeric(last_year)-1)%>%
  select(TCO2_Y2D)%>% pull

dif_co2_y2d_prev_year <- round((co2_y2d/co2_y2d_prev_year-1)*100,0)
dif_co2_y2d_prev_year <- paste0(if_else(dif_co2_y2d_prev_year>=0,'+', ''),dif_co2_y2d_prev_year,'%')


co2_y2d_2019 <- data_y2d%>%
  filter(YEAR==2019)%>%
  select(TCO2_Y2D)%>% pull

dif_co2_y2d_2019 <- round((co2_y2d/co2_y2d_2019-1)*100,1)
dif_co2_y2d_2019 <- paste0(if_else(dif_co2_y2d_2019>=0,'+', ''),format(dif_co2_y2d_2019, nsmall=1),'%')


dep_y2d_prev_year  <- data_y2d%>%
  filter(YEAR==as.numeric(last_year)-1)%>%
  select(TTF_Y2D)%>%pull

co2_dep_y2d <- co2_y2d/dep_y2d
co2_dep_y2d_r <- format(round(co2_dep_y2d,1), nsmall=1)
co2_dep_y2d_prev_year <- co2_y2d_prev_year/dep_y2d_prev_year

dif_co2_dep_y2d_prev_year <- round((co2_dep_y2d/co2_dep_y2d_prev_year-1)*100,1)
dif_co2_dep_y2d_prev_year <- paste0(if_else(dif_co2_dep_y2d_prev_year>=0,'+', ''),format(dif_co2_dep_y2d_prev_year, nsmall=1),'%')


dep_y2d_2019  <- data_y2d%>%
  filter(YEAR==2019)%>%
  select(TTF_Y2D)%>%pull
co2_dep_y2d_2019 <- co2_y2d_2019/dep_y2d_2019

dif_co2_dep_y2d_2019 <- round((co2_dep_y2d/co2_dep_y2d_2019-1)*100,1)
dif_co2_dep_y2d_2019 <- paste0(if_else(dif_co2_dep_y2d_2019>=0,'+', ''),format(dif_co2_dep_y2d_2019, nsmall=1),'%')


```

### CO<sub>2</sub> emissions
Intro.

#### Network (CRCO area)
<div class="container" style="padding:0px">
<div class="row align-items-start">

<div class="col-md-4" >
<br><br>
<div class="row align-items-start">
<div class="col-12" style="border: solid 1px #D9D9D9; border-radius: 4px;">
<div class="row align-items-start" style="margin-top:10px;">
<div class="col-5" >
<p style="font-weight:bold; color:#2E75B6; font-size:18px;  ">Month: `r last_month` </p>
</div>
<div class="col-4" >
<p style=" font-size:15px; margin-top:15px">vs 2021</p>
</div>
<div class="col-3" >
<p style="font-size:15px; margin-top:15px">vs 2019</p>
</div>
</div><!-- closes row -->

<div class="row align-items-start" style="">
<div class="col-5" >
<p style="font-weight:bold; font-size:22px; margin-bottom:0px">`r co2_month_r` Mt</p>
</div>
<div class="col-4" >
<p style="font-weight:bold; font-size:18px; margin-top:5px">`r dif_co2_month_prev_year`</p>
</div>
<div class="col-3" >
<p style="font-weight:bold; font-size:18px; margin-top:5px">`r dif_co2_month_2019`</p>
</div>
</div><!-- closes row -->

<div class="row align-items-start" style="">
<div class="col-5" >
<p style="font-weight:bold; font-size:22px; margin-bottom:0px">`r co2_dep_month_r` <span style="font-size:20px;">t/dep</span><span><a href="#" data-toggle="tooltip" data-placement="right" title="Tonnes of CO2 emissions per departure">*</a></span>
</p>
</div>
<div class="col-4" >
<p style="font-weight:bold; font-size:18px; margin-top:5px">`r dif_co2_dep_month_prev_year`</p>
</div>
<div class="col-3" >
<p style="font-weight:bold; font-size:18px; margin-top:5px">`r dif_co2_dep_month_2019`</p>
</div>
</div><!-- closes row -->


<div class="row align-items-start" style="">
<div class="col-12" >
<p style="font-weight:bold; color:#2E75B6; font-size:18px; margin-top:10px">`r y2d` </p>
</div>
</div><!-- closes row -->

<div class="row align-items-start" style="">
<div class="col-5" >
<p style="font-weight:bold; font-size:22px; margin-bottom:0px">`r co2_y2d_r` Mt</p>
</div>
<div class="col-4" >
<p style="font-weight:bold; font-size:18px; margin-top:5px">`r dif_co2_y2d_prev_year`</p>
</div>
<div class="col-3" >
<p style="font-weight:bold; font-size:18px; margin-top:5px">`r dif_co2_y2d_2019`</p>
</div>
</div><!-- closes row -->

<div class="row align-items-start" style="">
<div class="col-5" >
<p style="font-weight:bold; font-size:22px; margin-bottom:0px">`r co2_dep_y2d_r` <span style="font-size:20px;">t/dep</span><a href="#" data-toggle="tooltip" data-placement="right" title="Tonnes of CO2 emissions per departure">*</a></span>
</p>
</div>
<div class="col-4" >
<p style="font-weight:bold; font-size:18px; margin-top:5px">`r dif_co2_dep_y2d_prev_year`</p>
</div>
<div class="col-3" >
<p style="font-weight:bold; font-size:18px; margin-top:5px">`r dif_co2_dep_y2d_2019`</p>
</div>
</div><!-- closes row -->
</div></div>
</div><!-- closes col -->

<div class="col-md-8">

<ul class="nav nav-pills">
  <li class="active m-1"><a id="defaultTab2" data-toggle="pill" href="#co2dep">Option 1</a></li>
  <li class="m-1"><a data-toggle="pill" href="#deponly">Option 2</a></li>
  <li class="m-1"><a data-toggle="pill" href="#indexes">Option 3</a></li>
</ul>

<div class="tab-content">
<div id="co2dep" class="tab-pane fade in active">
```{r echo=FALSE, out.width='100%'}
co2_nw_plot
```
</div>

<div id="deponly" class="tab-pane fade">
```{r echo=FALSE, out.width='100%'}
co2_nw_plot2
```
</div>

<div id="indexes" class="tab-pane fade">
```{r echo=FALSE, out.width='100%'}
co2_nw_plot3
```
</div>
</div><!-- closes tabcontent -->
</div><!-- closes col -->

</div><!-- closes row -->
</div><!-- closes container -->

#### States

<ul class="nav nav-pills">
  <li class="active m-1"><a id="defaultTab" data-toggle="pill" href="#month">`r last_month`</a></li>
  <li class="m-1"><a data-toggle="pill" href="#y2d">Year to date (empty)</a></li>
  <li class="m-1"><a data-toggle="pill" href="#map">Map (empty)</a></li>
</ul>


<div class="tab-content">
<div id="month" class="container tab-pane fade in active" style="padding:0px">

<div class="row align-items-start">
<div class="col-md-12">

```{r echo=FALSE, out.width='100%'}
co2_state_plot
```

</div><!-- closes col -->

<div class="col-md-12">

```{r echo=FALSE, out.width='100%'}
co2_lolli_plot
```

</div><!-- closes col -->
</div><!-- closes row -->
</div><!-- closes container -->

<div class="tab-pane fade" id="y2d"></div>

</div>
<br>
For more information visit the EUROCONTROL page on [Aviation Sustainability](https://www.eurocontrol.int/aviation-sustainability){target="_blank"}.

(We can also add a catalog of products like in [this page](https://ansperformance.eu/capacity/tot_dly/){target="_blank"})

<script type="text/javascript">
window.onload = function() {
  var element = document.getElementById("defaultTab2");
  element.click();
  var element = document.getElementById("defaultTab");
  element.click();
}
</script>